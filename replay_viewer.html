<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTCG AI Replay Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0f172a;
            --p0-primary: #3b82f6;
            --p0-glow: rgba(59, 130, 246, 0.6);
            --p1-primary: #ef4444;
            --p1-glow: rgba(239, 68, 68, 0.6);
            --card-w: 115px;
            --card-ratio: 1.4;
            --card-h: calc(var(--card-w) * var(--card-ratio));
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            color: white;
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UI LAYER --- */
        .ui-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .top-bar {
            background: rgba(0, 0, 0, 0.92);
            border-bottom: 2px solid #333;
            padding: 10px 20px;
            pointer-events: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-selector {
            padding: 8px 12px;
            background: #1e293b;
            color: white;
            border: 1px solid #555;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            margin-right: 12px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .turn-badge {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            padding: 8px 18px;
            background: #333;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: 0.3s;
        }

        .turn-p0 {
            background: var(--p0-primary);
            box-shadow: 0 0 20px var(--p0-glow);
        }

        .turn-p1 {
            background: var(--p1-primary);
            box-shadow: 0 0 20px var(--p1-glow);
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        button {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            border: 1px solid #475569;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            font-size: 0.85rem;
        }

        button:hover {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
        }

        .toggle-btn {
            background: #1e293b;
            border: 1px solid #475569;
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .toggle-btn.active {
            background: #3b82f6;
            border-color: #60a5fa;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 10px;
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }

        .speed-control label {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .speed-control select {
            background: #1e293b;
            color: white;
            border: 1px solid #475569;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* --- ACTION LOG --- */
        .action-log {
            position: absolute;
            top: 65px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.92);
            border: 2px solid #555;
            padding: 12px 35px;
            border-radius: 25px;
            font-size: 1.1rem;
            backdrop-filter: blur(8px);
            text-align: center;
            min-width: 350px;
            z-index: 200;
        }

        /* --- SIDEBAR PREVIEW (BIGGER) --- */
        .sidebar-preview {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 230px;
            background: rgba(15, 23, 42, 0.95);
            border: 3px solid #334155;
            border-radius: 14px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(12px);
            pointer-events: auto;
            transition: all 0.3s ease;
        }

        .sidebar-p0 {
            border-color: var(--p0-primary);
            box-shadow: 0 0 25px var(--p0-glow);
        }

        .sidebar-p1 {
            border-color: var(--p1-primary);
            box-shadow: 0 0 25px var(--p1-glow);
        }

        .preview-header {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            margin-bottom: 12px;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-align: center;
        }

        .preview-card-frame {
            width: 180px;
            height: 252px;
            background: #1e293b;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            overflow: hidden;
            border: 2px solid #475569;
        }

        .preview-img {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
        }

        @keyframes pulse-glow {
            0% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.3);
            }

            100% {
                filter: brightness(1);
            }
        }

        .preview-update {
            animation: pulse-glow 0.4s ease-out;
        }

        .preview-name {
            margin-top: 12px;
            font-weight: bold;
            font-size: 1rem;
            text-align: center;
        }

        /* --- OPPONENT PREDICTION PANEL --- */
        .prediction-panel {
            position: absolute;
            left: 12px;
            bottom: 150px;
            width: 220px;
            background: rgba(15, 23, 42, 0.95);
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 12px;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }

        .prediction-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            color: #f59e0b;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .prediction-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prediction-item:last-child {
            border-bottom: none;
        }

        .prediction-icon {
            font-size: 1rem;
        }

        .prediction-high {
            color: #ef4444;
        }

        .prediction-medium {
            color: #f59e0b;
        }

        .prediction-low {
            color: #22c55e;
        }

        /* --- DISCARD PILE VIEWER (BIGGER) --- */
        .discard-viewer {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 210px;
            max-height: 480px;
            background: rgba(15, 23, 42, 0.95);
            border: 2px solid #475569;
            border-radius: 12px;
            padding: 12px;
            pointer-events: auto;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .discard-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: 1px;
            color: #94a3b8;
        }

        .discard-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .discard-tab {
            flex: 1;
            padding: 6px 8px;
            font-size: 0.75rem;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
        }

        .discard-tab.active {
            background: #3b82f6;
            border-color: #60a5fa;
        }

        .discard-tab:hover:not(.active) {
            background: #334155;
        }

        .discard-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
            max-height: 380px;
            overflow-y: auto;
        }

        .discard-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .discard-count {
            background: #ef4444;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* --- BOARD (BIGGER) --- */
        .board-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1500px;
            overflow: hidden;
            margin-top: -10px;
        }

        .game-board {
            width: 1350px;
            height: 880px;
            position: relative;
            transform: rotateX(28deg) scale(0.88);
            transform-style: preserve-3d;
            transition: transform 0.5s;
        }

        .arena-mat {
            position: absolute;
            inset: 0;
            background: linear-gradient(rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.95)), repeating-linear-gradient(45deg, #1e293b 0, #1e293b 1px, transparent 1px, transparent 10px);
            border: 5px solid #334155;
            border-radius: 35px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.9);
            z-index: 0;
        }

        .mid-line {
            position: absolute;
            top: 50%;
            left: 5%;
            right: 5%;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.12) 50%, transparent 100%);
        }

        /* STADIUM SLOT */
        .central-stadium-slot {
            position: absolute;
            top: 50%;
            left: 45px;
            transform: translateY(-50%);
            width: 160px;
            height: 224px;
            background: rgba(0, 0, 0, 0.4);
            border: 3px dashed #444;
            border-radius: 10px;
            z-index: 15;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .central-stadium-slot.active {
            border-style: solid;
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .zone-half {
            position: absolute;
            width: 100%;
            height: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .opponent-side {
            top: 0;
        }

        .player-side {
            bottom: 0;
            flex-direction: column-reverse;
        }

        .row-bench {
            display: flex;
            gap: 18px;
            margin: 22px 0;
            z-index: 10;
        }

        .row-active {
            display: flex;
            gap: 50px;
            align-items: center;
            margin-bottom: 22px;
            z-index: 20;
        }

        .slot {
            width: var(--card-w);
            height: var(--card-h);
            background: rgba(0, 0, 0, 0.22);
            border: 2px dashed rgba(255, 255, 255, 0.14);
            border-radius: 8px;
            position: relative;
        }

        .slot-active {
            width: calc(var(--card-w) * 1.3);
            height: calc(var(--card-h) * 1.3);
            border-color: rgba(255, 255, 255, 0.28);
            box-shadow: 0 0 35px rgba(0, 0, 0, 0.3);
        }

        /* CARDS */
        .card-group {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .card-main {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.55);
            border: 2px solid #333;
            transition: transform 0.2s;
        }

        .energy-card {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            border-radius: 6px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.45);
            border: 1px solid #222;
            z-index: 5;
        }

        .card-stadium {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
        }

        .hp-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: bold;
            border: 2px solid white;
            z-index: 20;
        }

        .status-indicators {
            position: absolute;
            bottom: -6px;
            left: -6px;
            display: flex;
            gap: 3px;
            z-index: 30;
        }

        .status-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px black;
        }

        .status-poisoned {
            background: #10b981;
        }

        .status-burned {
            background: #f59e0b;
        }

        .status-asleep {
            background: #6b7280;
        }

        .status-paralyzed {
            background: #facc15;
        }

        .status-confused {
            background: #8b5cf6;
        }

        .tool-indicator {
            position: absolute;
            top: -10px;
            left: -10px;
            background: #3b82f6;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            border: 2px solid white;
            z-index: 30;
        }

        /* --- 3D DECK STACK --- */
        .deck-3d {
            position: absolute;
            width: 80px;
            height: 112px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: 0.3s;
        }

        .deck-3d:hover {
            transform: translateY(-6px);
        }

        .deck-card-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: url('https://tcg.pokemon.com/assets/img/global/tcg-card-back.jpg');
            background-size: cover;
            border-radius: 5px;
            border: 1px solid #333;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .deck-label {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #888;
            white-space: nowrap;
        }

        .deck-count {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.75);
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 20;
        }

        .pos-deck-p0 {
            bottom: 35px;
            right: 90px;
        }

        .pos-deck-p1 {
            top: 35px;
            left: 90px;
        }

        /* TRASH */
        .trash-stack {
            position: absolute;
            width: 80px;
            height: 112px;
            border: 2px solid #444;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.45);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #888;
            cursor: pointer;
            transition: 0.2s;
        }

        .trash-stack:hover {
            border-color: #666;
            background: rgba(0, 0, 0, 0.65);
        }

        .pos-trash-p0 {
            bottom: 35px;
            right: 180px;
        }

        .pos-trash-p1 {
            top: 35px;
            left: 180px;
        }

        /* --- PRIZES (3x2 grid) --- */
        .prizes-container {
            position: absolute;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 5px;
        }

        .pos-prizes-p0 {
            bottom: 55px;
            left: 90px;
        }

        .pos-prizes-p1 {
            top: 55px;
            right: 90px;
        }

        .prize-card {
            width: 40px;
            height: 56px;
            background-image: url('https://tcg.pokemon.com/assets/img/global/tcg-card-back.jpg');
            background-size: cover;
            border-radius: 4px;
            border: 1px solid #444;
            transition: 0.2s;
            cursor: pointer;
            position: relative;
        }

        .prize-card:hover {
            transform: scale(1.4) translateY(-12px);
            z-index: 100;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
        }

        .prize-card.taken {
            opacity: 0.15;
            transform: scale(0.85);
        }

        .prize-card.taken:hover {
            transform: scale(0.85);
        }

        .prize-tooltip {
            position: absolute;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.92);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s;
            z-index: 200;
            border: 1px solid #555;
        }

        .prize-card:hover .prize-tooltip {
            opacity: 1;
        }

        /* --- HANDS --- */
        .hand-layer {
            position: absolute;
            left: 0;
            width: 100%;
            height: 150px;
            pointer-events: none;
            display: flex;
            justify-content: center;
            perspective: 1000px;
            z-index: 50;
        }

        .hand-p0 {
            bottom: 0px;
        }

        .hand-p1 {
            top: -35px;
            transform: scale(0.6);
            opacity: 0.8;
        }

        .hand-p1.hidden-hand {
            display: none;
        }

        .hand-card-wrapper {
            width: 100px;
            height: 140px;
            margin-left: -30px;
            transition: 0.22s ease-out;
            transform-origin: bottom center;
            pointer-events: auto;
            position: relative;
        }

        .hand-card-visual {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 -6px 15px rgba(0, 0, 0, 0.45);
            transition: 0.22s ease-out;
        }

        .hand-card-wrapper:hover {
            margin: 0 12px;
            transform: translateY(-85px) scale(1.5) !important;
            z-index: 100;
        }

        /* --- VISUAL EFFECTS --- */
        @keyframes attack-flash {
            0% {
                box-shadow: 0 0 0 rgba(255, 200, 0, 0);
            }

            30% {
                box-shadow: 0 0 60px rgba(255, 200, 0, 0.85);
            }

            100% {
                box-shadow: 0 0 0 rgba(255, 200, 0, 0);
            }
        }

        @keyframes shuffle-effect {

            0%,
            100% {
                transform: translateY(0);
            }

            25% {
                transform: translateY(-8px) rotate(-4deg);
            }

            75% {
                transform: translateY(-5px) rotate(4deg);
            }
        }

        .effect-attack {
            animation: attack-flash 0.45s ease-out;
        }

        .effect-shuffle {
            animation: shuffle-effect 0.4s ease-in-out;
        }

        /* --- MODAL --- */
        #fileModal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.97);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 45px;
            border-radius: 14px;
            border: 2px solid #334155;
            text-align: center;
        }

        .modal-box h2 {
            font-family: 'Orbitron', sans-serif;
            margin-top: 0;
            letter-spacing: 2px;
        }

        .hidden {
            display: none !important;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
    </style>
</head>

<body>

    <div id="fileModal">
        <div class="modal-box">
            <h2>üéÆ Load Replay</h2>
            <p style="color:#aaa; margin-bottom:20px">Select your <code
                    style="background:#334155; padding:3px 6px; border-radius:4px">recorded_replays.json</code></p>
            <input type="file" id="fileInput" accept=".json" style="font-size:1rem">
        </div>
    </div>

    <div class="ui-layer">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:12px">
                <select id="gameSelector" class="game-selector" onchange="switchGame(this.value)">
                    <option value="0">Waiting for file...</option>
                </select>
                <div id="turnBadge" class="turn-badge turn-p0">Player Turn</div>
                <button class="toggle-btn" id="toggleHandBtn" onclick="toggleOpponentHand()">üëÅ Hide Opp Hand</button>
            </div>

            <div class="controls">
                <button onclick="goToStart()">‚èÆ Start</button>
                <button onclick="nav(-1)">‚óÄ Prev</button>
                <button id="playBtn" onclick="togglePlay()">‚ñ∂ Play</button>
                <button onclick="nav(1)">Next ‚ñ∂</button>
                <button onclick="goToEnd()">End ‚è≠</button>

                <div class="speed-control">
                    <label>Speed:</label>
                    <select id="speedSelect" onchange="updateSpeed()">
                        <option value="1200">0.5x</option>
                        <option value="800">0.75x</option>
                        <option value="550" selected>1x</option>
                        <option value="350">1.5x</option>
                        <option value="200">2x</option>
                        <option value="100">3x</option>
                    </select>
                </div>

                <span id="counter" style="margin-left:12px; font-family:monospace; font-size:1rem">0/0</span>
            </div>
        </div>

        <div class="action-log">
            <div id="actMain" style="color:white; font-weight:bold; font-size:1.05rem">Waiting...</div>
            <div id="actSub" style="color:#94a3b8; font-size:0.85em; margin-top:5px"></div>
        </div>

        <div class="sidebar-preview" id="sidebarPreview" style="opacity: 0.4">
            <div id="previewHeader" class="preview-header">Last Action</div>
            <div class="preview-card-frame">
                <div id="previewImg" class="preview-img"></div>
            </div>
            <div id="previewName" class="preview-name">-</div>
        </div>

        <!-- Opponent Prediction Panel -->
        <div class="prediction-panel" id="predictionPanel">
            <div class="prediction-title">üîÆ OPPONENT INTEL</div>
            <div id="predictionList">
                <div class="prediction-item">
                    <span class="prediction-icon">üìä</span>
                    <span>Loading...</span>
                </div>
            </div>
        </div>

        <div class="discard-viewer" id="discardViewer">
            <div class="discard-title">üì¶ DISCARD PILE</div>
            <div class="discard-tabs">
                <div class="discard-tab active" onclick="showDiscard(0)" id="discardTab0">P0</div>
                <div class="discard-tab" onclick="showDiscard(1)" id="discardTab1">P1</div>
            </div>
            <div class="discard-list" id="discardList"></div>
        </div>

        <div class="hand-layer hand-p1" id="p1Hand"></div>
        <div class="hand-layer hand-p0" id="p0Hand"></div>
    </div>

    <div class="board-container">
        <div class="game-board">
            <div class="arena-mat"></div>
            <div class="mid-line"></div>

            <div class="central-stadium-slot" id="mainStadium">
                <span style="font-size:0.75rem; color:#555; letter-spacing:1px">STADIUM</span>
            </div>

            <div class="zone-half opponent-side">
                <div class="deck-3d pos-deck-p1" id="p1Deck"></div>
                <div class="trash-stack pos-trash-p1" id="p1Trash" onclick="showDiscard(1)">TRASH<br><strong
                        style="color:#ef4444; font-size:1.2em">0</strong></div>
                <div class="prizes-container pos-prizes-p1" id="p1Prizes"></div>

                <div class="row-bench" id="p1Bench"></div>
                <div class="row-active">
                    <div class="slot slot-active" id="p1Active"></div>
                </div>
            </div>

            <div class="zone-half player-side">
                <div class="deck-3d pos-deck-p0" id="p0Deck"></div>
                <div class="trash-stack pos-trash-p0" id="p0Trash" onclick="showDiscard(0)">TRASH<br><strong
                        style="color:#ef4444; font-size:1.2em">0</strong></div>
                <div class="prizes-container pos-prizes-p0" id="p0Prizes"></div>

                <div class="row-bench" id="p0Bench"></div>
                <div class="row-active">
                    <div class="slot slot-active" id="p0Active"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rawData = null;
        let replay = null;
        let frameIdx = 0;
        let isPlaying = false;
        let playTimer = null;
        let currentDiscardPlayer = 0;
        let hideOpponentHand = false;
        let playSpeed = 550;

        document.getElementById('fileInput').addEventListener('change', e => {
            const r = new FileReader();
            r.onload = ev => {
                try {
                    const json = JSON.parse(ev.target.result);
                    rawData = json;
                    const selector = document.getElementById('gameSelector');
                    selector.innerHTML = '';

                    if (json.replays && Array.isArray(json.replays)) {
                        json.replays.forEach((g, i) => {
                            const opt = document.createElement('option');
                            opt.value = i;
                            const winner = g.winner === 0 ? "P0 (AI)" : (g.winner === 1 ? "P1 (Opp)" : "Draw");
                            opt.textContent = `Game ${i + 1}: ${winner} (${g.total_frames} turns)`;
                            selector.appendChild(opt);
                        });
                        loadGame(0);
                    } else {
                        const opt = document.createElement('option');
                        opt.value = 0;
                        opt.textContent = "Single Game";
                        selector.appendChild(opt);
                        rawData = { replays: [json] };
                        loadGame(0);
                    }
                    document.getElementById('fileModal').classList.add('hidden');
                } catch (e) {
                    console.error(e);
                    alert("Invalid JSON");
                }
            };
            r.readAsText(e.target.files[0]);
        });

        function switchGame(index) { loadGame(parseInt(index)); }

        function loadGame(index) {
            if (isPlaying) togglePlay();
            replay = rawData.replays[index];
            frameIdx = 0;
            render(0);
        }

        function sanitize(name) {
            if (!name) return '';
            return String(name).normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim()
                .replace(/[^a-zA-Z0-9]+/g, '_').replace(/^_+|_+$/g, '');
        }

        function getAttachedList(mon) {
            if (mon.attached_cards && Array.isArray(mon.attached_cards)) return mon.attached_cards;
            if (mon.energy && Array.isArray(mon.energy)) return mon.energy;
            const count = mon.energy_count || mon.energy || 0;
            if (typeof count === 'number' && count > 0) return Array(count).fill("Energy");
            return [];
        }

        function updateSpeed() {
            playSpeed = parseInt(document.getElementById('speedSelect').value);
            if (isPlaying) {
                clearInterval(playTimer);
                playTimer = setInterval(() => {
                    if (frameIdx < replay.frames.length - 1) render(frameIdx + 1);
                    else togglePlay();
                }, playSpeed);
            }
        }

        function toggleOpponentHand() {
            hideOpponentHand = !hideOpponentHand;
            const btn = document.getElementById('toggleHandBtn');
            btn.classList.toggle('active', hideOpponentHand);
            btn.textContent = hideOpponentHand ? 'üëÅ Show Opp Hand' : 'üëÅ Hide Opp Hand';
            document.getElementById('p1Hand').classList.toggle('hidden-hand', hideOpponentHand);
        }

        function showDiscard(player) {
            currentDiscardPlayer = player;
            document.getElementById('discardTab0').classList.toggle('active', player === 0);
            document.getElementById('discardTab1').classList.toggle('active', player === 1);
            updateDiscardList();
        }

        function updateDiscardList() {
            if (!replay) return;
            const f = replay.frames[frameIdx];
            const data = currentDiscardPlayer === 0 ? f.p0 : f.p1;
            const list = document.getElementById('discardList');
            list.innerHTML = '';

            if (!data) return;

            const discardPile = data.discard_pile || [];

            if (discardPile.length === 0) {
                list.innerHTML = `<div style="color:#666; text-align:center; padding:15px; font-size:0.8rem">Empty</div>`;
                return;
            }

            const counts = {};
            discardPile.forEach(card => { counts[card] = (counts[card] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            sorted.forEach(([card, count]) => {
                const item = document.createElement('div');
                item.className = 'discard-item';
                item.innerHTML = `<span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${card}</span><span class="discard-count">${count}</span>`;
                item.title = card;
                list.appendChild(item);
            });
        }

        function goToStart() { if (replay) render(0); }
        function goToEnd() { if (replay) render(replay.frames.length - 1); }

        function render3DDeck(containerId, count) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            const layers = Math.min(10, Math.max(1, Math.floor(count / 4)));
            for (let i = 0; i < layers; i++) {
                const layer = document.createElement('div');
                layer.className = 'deck-card-layer';
                layer.style.top = `${-i * 2}px`;
                layer.style.left = `${i * 0.5}px`;
                layer.style.zIndex = layers - i;
                container.appendChild(layer);
            }

            const countEl = document.createElement('div');
            countEl.className = 'deck-count';
            countEl.textContent = count;
            container.appendChild(countEl);

            const label = document.createElement('div');
            label.className = 'deck-label';
            label.textContent = 'DECK';
            container.appendChild(label);
        }

        function render(idx) {
            if (!replay) return;
            frameIdx = idx;
            const f = replay.frames[idx];

            document.getElementById('counter').textContent = `${idx}/${replay.total_frames - 1}`;
            document.getElementById('actMain').textContent = f.action_description || "Start";
            document.getElementById('actSub').textContent = f.action_result || "";

            // Sidebar
            const sidebar = document.getElementById('sidebarPreview');
            const header = document.getElementById('previewHeader');
            const prevImg = document.getElementById('previewImg');
            const prevName = document.getElementById('previewName');

            sidebar.classList.remove('sidebar-p0', 'sidebar-p1');

            const p0Name = replay.p0_deck_name || "ALAKAZAM";
            const p1Name = replay.p1_deck_name || "CHARIZARD";

            if (f.turn_player === 0) {
                sidebar.classList.add('sidebar-p0');
                header.style.color = 'var(--p0-primary)';
                header.textContent = `${p0Name}'S MOVE`;
            } else {
                sidebar.classList.add('sidebar-p1');
                header.style.color = 'var(--p1-primary)';
                header.textContent = `${p1Name}'S MOVE`;
            }

            if (f.action_kind === 'PASS') {
                prevImg.style.backgroundImage = `url("./cards/END_TURN.png")`;
                prevName.textContent = 'End Turn';
                sidebar.style.opacity = '1';
                prevImg.classList.remove('preview-update');
                void prevImg.offsetWidth;
                prevImg.classList.add('preview-update');
            } else if (f.action_card) {
                prevImg.style.backgroundImage = `url("./cards/${sanitize(f.action_card)}.png")`;
                prevName.textContent = f.action_card;
                sidebar.style.opacity = '1';
                prevImg.classList.remove('preview-update');
                void prevImg.offsetWidth;
                prevImg.classList.add('preview-update');
            } else {
                sidebar.style.opacity = '0.5';
                prevName.textContent = '-';
                prevImg.style.backgroundImage = '';
            }

            // Turn badge
            const badge = document.getElementById('turnBadge');
            if (f.winner !== null) {
                badge.textContent = `üèÜ ${f.winner === 0 ? p0Name : p1Name} WINS!`;
                badge.className = f.winner === 0 ? 'turn-badge turn-p0' : 'turn-badge turn-p1';
            } else {
                badge.textContent = `${f.turn_player === 0 ? p0Name : p1Name}'S TURN`;
                badge.className = f.turn_player === 0 ? 'turn-badge turn-p0' : 'turn-badge turn-p1';
            }

            // Stadium
            let stadiumName = f.stadium || f.board?.stadium || f.p0?.stadium || f.p1?.stadium || null;
            if (stadiumName && typeof stadiumName === 'object' && stadiumName.name) stadiumName = stadiumName.name;

            const stadSlot = document.getElementById('mainStadium');
            stadSlot.innerHTML = '';
            stadSlot.classList.remove('active');
            if (stadiumName) {
                const sCard = document.createElement('div');
                sCard.className = 'card-stadium';
                sCard.title = stadiumName;
                sCard.style.backgroundImage = `url("./cards/${sanitize(stadiumName)}.png")`;
                stadSlot.appendChild(sCard);
                stadSlot.classList.add('active');
            } else {
                stadSlot.innerHTML = '<span style="font-size:0.75rem; color:#555; letter-spacing:1px">STADIUM</span>';
            }

            applyEffects(f);
            renderSide(f.p0, 'p0');
            renderSide(f.p1, 'p1');
            updateDiscardList();
            updatePredictions(f);
        }

        function updatePredictions(f) {
            const predList = document.getElementById('predictionList');
            if (!predList) return;

            // Get opponent data (from current player's perspective)
            const viewingPlayer = f.turn_player;
            const opData = viewingPlayer === 0 ? f.p1 : f.p0;
            if (!opData) return;

            let predictions = [];

            // Check predicted_threats from replay data
            if (opData.predicted_threats && opData.predicted_threats.length > 0) {
                opData.predicted_threats.forEach(threat => {
                    predictions.push({ icon: '‚ö†Ô∏è', text: threat, level: 'high' });
                });
            }

            // Analyze opponent's field for evolution threats
            let unevolved = 0;
            let evolved = 0;
            if (opData.active && opData.active.name) {
                // Simple heuristic: check if they have low HP basics
            }
            if (opData.bench) {
                opData.bench.forEach(slot => {
                    if (slot && slot.name) {
                        // Check if it looks like an evolution starter (low HP basic)
                        if (slot.damage_taken === 0 && !slot.name.includes('ex')) {
                            unevolved++;
                        }
                    }
                });
            }

            if (unevolved >= 2) {
                predictions.push({ icon: 'üîÑ', text: `${unevolved} unevolved targets`, level: 'medium' });
            }

            // Hand size analysis
            if (opData.hand_size !== undefined) {
                if (opData.hand_size >= 7) {
                    predictions.push({ icon: 'üÉè', text: `Large hand (${opData.hand_size} cards)`, level: 'high' });
                } else if (opData.hand_size <= 2) {
                    predictions.push({ icon: 'üìâ', text: `Low hand (${opData.hand_size} cards)`, level: 'low' });
                } else {
                    predictions.push({ icon: 'üÉè', text: `Hand: ${opData.hand_size} cards`, level: 'medium' });
                }
            }

            // Deck size warning
            if (opData.deck_size !== undefined && opData.deck_size <= 10) {
                predictions.push({ icon: 'üìö', text: `Low deck: ${opData.deck_size} cards`, level: 'low' });
            }

            // Supporter tracking
            const turnsSinceSup = opData.turns_since_supporter || 0;
            if (turnsSinceSup === 0) {
                predictions.push({ icon: 'üé¥', text: 'Used Supporter recently', level: 'medium' });
            } else if (turnsSinceSup >= 3) {
                predictions.push({ icon: '‚ùì', text: 'No Supporter in 3+ turns', level: 'low' });
            }

            // Last search info
            if (opData.last_searched_type) {
                predictions.push({ icon: 'üîç', text: `Searched: ${opData.last_searched_type}`, level: 'high' });
            }

            // Default if no predictions
            if (predictions.length === 0) {
                predictions.push({ icon: 'üìä', text: 'Analyzing opponent...', level: 'medium' });
            }

            // Render predictions
            predList.innerHTML = predictions.map(p => `
                <div class="prediction-item prediction-${p.level}">
                    <span class="prediction-icon">${p.icon}</span>
                    <span>${p.text}</span>
                </div>
            `).join('');
        }

        function applyEffects(f) {
            if (f.action_kind === 'ATTACK') {
                const activeSlot = f.turn_player === 0 ? document.getElementById('p0Active') : document.getElementById('p1Active');
                activeSlot.classList.remove('effect-attack');
                void activeSlot.offsetWidth;
                activeSlot.classList.add('effect-attack');
            }

            if (f.action_result && f.action_result.toLowerCase().includes('shuffle')) {
                const deckEl = f.turn_player === 0 ? document.getElementById('p0Deck') : document.getElementById('p1Deck');
                deckEl.classList.remove('effect-shuffle');
                void deckEl.offsetWidth;
                deckEl.classList.add('effect-shuffle');
            }
        }

        function renderSide(data, p) {
            if (!data) return;

            // Hand
            const h = document.getElementById(`${p}Hand`);
            h.innerHTML = '';
            const handLen = data.hand.length;
            const startAngle = -(handLen - 1) * 2.2;
            data.hand.forEach((card, i) => {
                const w = document.createElement('div');
                w.className = 'hand-card-wrapper';
                w.title = card;
                const angle = startAngle + (i * 4.4);
                w.style.transform = `rotate(${angle}deg) translateY(${Math.abs(angle) * 0.35}px)`;
                w.innerHTML = `<div class="hand-card-visual" style="background-image: url(&quot;./cards/${sanitize(card)}.png&quot;)"></div>`;
                h.appendChild(w);
            });

            // Active
            const act = document.getElementById(`${p}Active`);
            act.innerHTML = '';
            if (data.active && data.active.name) act.appendChild(createStackedCard(data.active));

            // Bench
            const ben = document.getElementById(`${p}Bench`);
            ben.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                if (data.bench[i]) slot.appendChild(createStackedCard(data.bench[i]));
                ben.appendChild(slot);
            }

            // 3D Deck
            render3DDeck(`${p}Deck`, data.deck_size);

            // Trash
            document.getElementById(`${p}Trash`).innerHTML = `TRASH<br><strong style="color:#ef4444; font-size:1.2em">${data.discard_size}</strong>`;

            // Prizes (6 cards in 3x2 grid) - BOTH players can hover
            const prz = document.getElementById(`${p}Prizes`);
            prz.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                const c = document.createElement('div');
                const isTaken = i >= data.prizes_remaining;
                c.className = `prize-card ${isTaken ? 'taken' : ''}`;

                // Tooltip for ALL prize cards (both P0 and P1)
                if (data.prizes && data.prizes[i] && !isTaken) {
                    const tip = document.createElement('div');
                    tip.className = 'prize-tooltip';
                    tip.textContent = data.prizes[i];
                    c.appendChild(tip);
                }
                prz.appendChild(c);
            }
        }

        function createStackedCard(mon) {
            const group = document.createElement('div');
            group.className = 'card-group';

            if (mon.status) {
                const indicators = document.createElement('div');
                indicators.className = 'status-indicators';
                for (const [key, val] of Object.entries(mon.status)) {
                    if (val === true) {
                        const dot = document.createElement('div');
                        dot.className = `status-dot status-${key}`;
                        dot.title = key;
                        indicators.appendChild(dot);
                    }
                }
                group.appendChild(indicators);
            }

            if (mon.tool) {
                const tool = document.createElement('div');
                tool.className = 'tool-indicator';
                tool.textContent = 'T';
                tool.title = `Tool: ${mon.tool}`;
                group.appendChild(tool);
            }

            const attached = getAttachedList(mon);
            attached.forEach((cardName, index) => {
                const energy = document.createElement('div');
                energy.className = 'energy-card';
                energy.style.backgroundImage = `url("./cards/${sanitize(cardName)}.png")`;
                energy.style.top = `${(index + 1) * 18}px`;
                energy.style.zIndex = 5 - index;
                group.appendChild(energy);
            });

            const main = document.createElement('div');
            main.className = 'card-main';
            main.style.backgroundImage = `url("./cards/${sanitize(mon.name)}.png")`;

            if (mon.damage > 0) {
                const hp = document.createElement('div');
                hp.className = 'hp-badge';
                hp.textContent = `-${mon.damage}`;
                main.appendChild(hp);
            }

            group.appendChild(main);
            return group;
        }

        function nav(d) {
            const n = frameIdx + d;
            if (n >= 0 && n < replay.frames.length) render(n);
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            document.getElementById('playBtn').textContent = isPlaying ? "‚è∏ Pause" : "‚ñ∂ Play";
            if (isPlaying) playTimer = setInterval(() => {
                if (frameIdx < replay.frames.length - 1) render(frameIdx + 1);
                else togglePlay();
            }, playSpeed);
            else clearInterval(playTimer);
        }

        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') nav(-1);
            else if (e.key === 'ArrowRight') nav(1);
            else if (e.key === ' ') { e.preventDefault(); togglePlay(); }
            else if (e.key === 'Home') goToStart();
            else if (e.key === 'End') goToEnd();
            else if (e.key === 'h' || e.key === 'H') toggleOpponentHand();
        });
    </script>
</body>

</html>